# ============================================================
# üöÄ FORMALYSE - Release Compl√®tement Automatique
# ============================================================
# Ce script :
# 1. Build l'application
# 2. Cr√©e la release GitHub
# 3. Upload les fichiers automatiquement
# 4. Publie la release
# ============================================================

param(
    [Parameter(Mandatory=$false)]
    [ValidateSet('patch', 'minor', 'major')]
    [string]$VersionType,
    
    [Parameter(Mandatory=$false)]
    [string]$GitHubToken
)

# Arr√™ter en cas d'erreur
$ErrorActionPreference = "Stop"

# ============================================================
# Configuration
# ============================================================

$REPO_OWNER = "YoanBLGR"
$REPO_NAME = "Outil-formalites"

# ============================================================
# Fonctions utilitaires
# ============================================================

function Write-Step {
    param([string]$Message)
    Write-Host "`n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó" -ForegroundColor Cyan
    Write-Host "‚ïë  $Message" -ForegroundColor Cyan
    Write-Host "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù`n" -ForegroundColor Cyan
}

function Write-Success {
    param([string]$Message)
    Write-Host "‚úÖ $Message" -ForegroundColor Green
}

function Write-Info {
    param([string]$Message)
    Write-Host "‚ÑπÔ∏è  $Message" -ForegroundColor Blue
}

function Write-Warning {
    param([string]$Message)
    Write-Host "‚ö†Ô∏è  $Message" -ForegroundColor Yellow
}

function Write-Error-Custom {
    param([string]$Message)
    Write-Host "‚ùå $Message" -ForegroundColor Red
}

# ============================================================
# √âtape 1 : V√©rifier le token GitHub
# ============================================================

Write-Step "üîê V√©rification du token GitHub"

if (-not $GitHubToken) {
    $GitHubToken = $env:GITHUB_TOKEN
}

if (-not $GitHubToken) {
    Write-Warning "Aucun token GitHub fourni."
    Write-Info "Vous pouvez :"
    Write-Info "  1. Cr√©er un token sur : https://github.com/settings/tokens"
    Write-Info "  2. Le passer en param√®tre : -GitHubToken 'ghp_xxxxx'"
    Write-Info "  3. Ou d√©finir la variable : `$env:GITHUB_TOKEN = 'ghp_xxxxx'"
    Write-Host ""
    
    $useManual = Read-Host "Continuer en mode manuel (upload navigateur) ? (y/n)"
    if ($useManual -ne 'y') {
        exit 1
    }
    $ManualMode = $true
} else {
    Write-Success "Token GitHub d√©tect√©"
    $ManualMode = $false
}

# ============================================================
# √âtape 2 : Choix de la version
# ============================================================

Write-Step "üìå Choix de la version"

if (-not $VersionType) {
    Write-Host "Quelle version voulez-vous publier ?`n"
    Write-Host "  1. Patch (1.0.3 ‚Üí 1.0.4)  - Correctifs mineurs"
    Write-Host "  2. Minor (1.0.3 ‚Üí 1.1.0)  - Nouvelles fonctionnalit√©s"
    Write-Host "  3. Major (1.0.3 ‚Üí 2.0.0)  - Changements majeurs"
    Write-Host ""
    
    $choice = Read-Host "Votre choix (1/2/3)"
    
    switch ($choice) {
        "1" { $VersionType = "patch" }
        "2" { $VersionType = "minor" }
        "3" { $VersionType = "major" }
        default {
            Write-Error-Custom "Choix invalide !"
            exit 1
        }
    }
}

Write-Success "Type de version : $VersionType"

# ============================================================
# √âtape 3 : Incr√©menter la version
# ============================================================

Write-Step "üîÑ Incr√©mentation de la version"

npm version $VersionType --no-git-tag-version 2>&1 | Out-Null
if ($LASTEXITCODE -ne 0) {
    Write-Error-Custom "Erreur lors de l'incr√©mentation de version"
    exit 1
}

# Lire la nouvelle version
$packageJson = Get-Content "package.json" | ConvertFrom-Json
$version = $packageJson.version

Write-Success "Nouvelle version : $version"

# ============================================================
# √âtape 4 : Build de l'application
# ============================================================

Write-Step "üî® Build de l'application Tauri"
Write-Info "‚è±Ô∏è  Cela peut prendre 2-3 minutes..."

npm run tauri:build
if ($LASTEXITCODE -ne 0) {
    Write-Error-Custom "Build √©chou√© !"
    exit 1
}

Write-Success "Build termin√© avec succ√®s !"

# ============================================================
# √âtape 5 : V√©rifier les fichiers
# ============================================================

Write-Step "üì¶ V√©rification des fichiers"

$exePath = "src-tauri\target\release\bundle\nsis\Formalyse_${version}_x64-setup.exe"
$msiPath = "src-tauri\target\release\bundle\msi\Formalyse_${version}_x64_en-US.msi"

if (-not (Test-Path $exePath)) {
    Write-Error-Custom "Fichier introuvable : $exePath"
    exit 1
}

Write-Success "Installateur trouv√© : $exePath"
if (Test-Path $msiPath) {
    Write-Success "MSI trouv√© : $msiPath"
}

# ============================================================
# √âtape 6 : G√©n√©rer latest.json
# ============================================================

Write-Step "üìù G√©n√©ration de latest.json"

$downloadUrl = "https://github.com/$REPO_OWNER/$REPO_NAME/releases/download/v${version}/Formalyse_${version}_x64-setup.exe"
$pubDate = (Get-Date).ToUniversalTime().ToString("yyyy-MM-ddTHH:mm:ssZ")

$latestJson = @{
    version = $version
    notes = "Release version $version"
    pub_date = $pubDate
    platforms = @{
        "windows-x86_64" = @{
            url = $downloadUrl
        }
    }
} | ConvertTo-Json -Depth 10

$latestJson | Out-File -FilePath "latest.json" -Encoding utf8NoBOM

Write-Success "latest.json cr√©√© !"

# ============================================================
# √âtape 7 : Commit et tag Git
# ============================================================

Write-Step "üì¶ Commit et tag Git"

git add package.json src-tauri/tauri.conf.json
git commit -m "$version"
git tag "v$version"

Write-Success "Commit et tag cr√©√©s !"

# ============================================================
# √âtape 8 : Push sur GitHub
# ============================================================

Write-Step "üåê Push sur GitHub"

git push origin main
git push origin "v$version"

Write-Success "Pouss√© sur GitHub !"

# ============================================================
# √âtape 9 : Cr√©er la release GitHub
# ============================================================

if ($ManualMode) {
    # Mode manuel
    Write-Step "üéÅ Cr√©ation de la release (manuel)"
    
    Write-Host "`n‚ö†Ô∏è  Pour cr√©er la release, vous devez :`n"
    Write-Host "   1. Aller sur : https://github.com/$REPO_OWNER/$REPO_NAME/releases/new"
    Write-Host "   2. Tag : v$version"
    Write-Host "   3. Title : Formalyse v$version"
    Write-Host "   4. Uploader ces fichiers :"
    Write-Host "      - $exePath"
    Write-Host "      - latest.json"
    Write-Host ""
    
    # Ouvrir le navigateur
    Start-Process "https://github.com/$REPO_OWNER/$REPO_NAME/releases/new?tag=v$version&title=Formalyse%20v$version"
    
    # Ouvrir l'explorateur
    Start-Process "explorer.exe" -ArgumentList "/select,`"$exePath`""
    
} else {
    # Mode automatique avec API GitHub
    Write-Step "üéÅ Cr√©ation de la release GitHub (automatique)"
    
    $headers = @{
        "Authorization" = "Bearer $GitHubToken"
        "Accept" = "application/vnd.github+json"
        "X-GitHub-Api-Version" = "2022-11-28"
    }
    
    # Cr√©er la release
    Write-Info "Cr√©ation de la release..."
    
    $releaseBody = @{
        tag_name = "v$version"
        name = "Formalyse v$version"
        body = "## üöÄ Release v$version`n`nMise √† jour vers la version $version.`n`n### üì• Installation`n`nT√©l√©chargez l'installateur Windows ci-dessous.`n`n### üîÑ Mise √† jour automatique`n`nSi vous avez d√©j√† Formalyse install√©, l'application d√©tectera automatiquement cette mise √† jour."
        draft = $false
        prerelease = $false
    } | ConvertTo-Json
    
    try {
        $release = Invoke-RestMethod -Uri "https://api.github.com/repos/$REPO_OWNER/$REPO_NAME/releases" `
            -Method POST `
            -Headers $headers `
            -Body $releaseBody `
            -ContentType "application/json"
        
        Write-Success "Release cr√©√©e : $($release.html_url)"
        
        # Upload des fichiers
        Write-Info "Upload de l'installateur..."
        
        $uploadUrl = $release.upload_url -replace '\{\?name,label\}', ''
        
        # Upload .exe
        $exeBytes = [System.IO.File]::ReadAllBytes((Resolve-Path $exePath))
        $exeName = Split-Path $exePath -Leaf
        
        Invoke-RestMethod -Uri "$uploadUrl?name=$exeName" `
            -Method POST `
            -Headers $headers `
            -Body $exeBytes `
            -ContentType "application/octet-stream" | Out-Null
        
        Write-Success "Installateur upload√© : $exeName"
        
        # Upload latest.json
        Write-Info "Upload de latest.json..."
        
        $jsonBytes = [System.IO.File]::ReadAllBytes((Resolve-Path "latest.json"))
        
        Invoke-RestMethod -Uri "$uploadUrl?name=latest.json" `
            -Method POST `
            -Headers $headers `
            -Body $jsonBytes `
            -ContentType "application/json" | Out-Null
        
        Write-Success "latest.json upload√©"
        
        # Upload .msi si pr√©sent
        if (Test-Path $msiPath) {
            Write-Info "Upload du MSI..."
            
            $msiBytes = [System.IO.File]::ReadAllBytes((Resolve-Path $msiPath))
            $msiName = Split-Path $msiPath -Leaf
            
            Invoke-RestMethod -Uri "$uploadUrl?name=$msiName" `
                -Method POST `
                -Headers $headers `
                -Body $msiBytes `
                -ContentType "application/octet-stream" | Out-Null
            
            Write-Success "MSI upload√© : $msiName"
        }
        
    } catch {
        Write-Error-Custom "Erreur lors de la cr√©ation de la release : $($_.Exception.Message)"
        Write-Warning "Vous pouvez cr√©er la release manuellement sur GitHub"
        exit 1
    }
}

# ============================================================
# R√©sum√© final
# ============================================================

Write-Host "`n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó" -ForegroundColor Green
Write-Host "‚ïë                    ‚úÖ Release publi√©e !                        ‚ïë" -ForegroundColor Green
Write-Host "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù`n" -ForegroundColor Green

Write-Host "üìã R√©capitulatif :" -ForegroundColor Cyan
Write-Host "   ‚Ä¢ Version : $version" -ForegroundColor White
Write-Host "   ‚Ä¢ Build : ‚úì" -ForegroundColor Green
Write-Host "   ‚Ä¢ Git : ‚úì" -ForegroundColor Green
Write-Host "   ‚Ä¢ Release GitHub : ‚úì" -ForegroundColor Green
if (-not $ManualMode) {
    Write-Host "   ‚Ä¢ Upload automatique : ‚úì" -ForegroundColor Green
}
Write-Host ""
Write-Host "üåê Voir la release : https://github.com/$REPO_OWNER/$REPO_NAME/releases/tag/v$version" -ForegroundColor Blue
Write-Host ""
Write-Host "üéØ Les utilisateurs vont recevoir la notification de mise √† jour automatiquement !" -ForegroundColor Yellow
Write-Host ""

