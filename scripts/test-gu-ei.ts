/**
 * Script de test pour l'int√©gration Guichet Unique - Entrepreneur Individuel
 * 
 * Ce script permet de tester :
 * - La validation des donn√©es EI
 * - Le mapping EI ‚Üí format Guichet Unique
 * - La structure JSON g√©n√©r√©e
 * - Optionnellement, la cr√©ation r√©elle d'une formalit√© (si credentials configur√©s)
 * 
 * Usage:
 *   npx ts-node scripts/test-gu-ei.ts [--dry-run|--create]
 * 
 * Options:
 *   --dry-run : Valide et affiche la structure sans cr√©er (d√©faut)
 *   --create  : Cr√©e r√©ellement la formalit√© sur le GU (n√©cessite .env configur√©)
 */

// Charger les variables d'environnement depuis .env
import { config } from 'dotenv'
config()

import type { Dossier, EntrepreneurIndividuel, Client } from '../src/types'
import { validateDossierEIForGU, mapDossierEIToGUFormality } from '../src/utils/gu-mapper-ei'
import { createDraftFormality, isGuichetUniqueConfigured } from '../src/services/guichet-unique-api'
import { v4 as uuidv4 } from 'uuid'

// ==============================================
// DONN√âES DE TEST
// ==============================================

const testClient: Client = {
  civilite: 'M',
  nom: 'Dupont',
  prenom: 'Jean',
  email: 'jean.dupont@example.com',
  telephone: '06 12 34 56 78',
}

const testEI: EntrepreneurIndividuel = {
  genre: 'M',
  prenoms: 'Jean Pierre',
  nomNaissance: 'DUPONT',
  nomUsage: undefined,
  dateNaissance: '1985-03-15',
  villeNaissance: 'Paris',
  lieuNaissance: 'Paris (75)',
  paysNaissance: 'France',
  nationalite: 'Fran√ßaise',
  situationMatrimoniale: 'Mari√©',
  commercantAmbulant: false,
  declarationType: 'mensuelle',
  adresseEntrepreneur: '25 Rue de la R√©publique 75011 PARIS',
  adresseEtablissement: '25 Rue de la R√©publique 75011 PARIS', // M√™me adresse
  email: 'jean.dupont@example.com',
  telephone: '06 12 34 56 78',
  numeroSecuriteSociale: '1 85 03 75 056 001 23', // Sera normalis√©
  nomCommercial: 'JD Conseil',
  domiciliationDomicile: true,
  adresseDomicile: '25 Rue de la R√©publique 75011 PARIS',
  nombreActivites: 1,
  descriptionActivites: 'Conseil en strat√©gie et organisation d\'entreprise',
  optionVersementLiberatoire: true,
  codeInseeNaissance: '75056', // Paris
}

const testDossier: Dossier = {
  id: uuidv4(),
  numero: 'TEST-EI-2024-001',
  createdAt: new Date().toISOString(),
  updatedAt: new Date().toISOString(),
  typeDossier: 'EI',
  client: testClient,
  entrepreneurIndividuel: testEI,
  statut: 'NOUVEAU',
  documents: [],
  checklist: [],
  timeline: [
    {
      id: uuidv4(),
      type: 'CREATION',
      description: 'Dossier test EI cr√©√©',
      createdAt: new Date().toISOString(),
      createdBy: 'Script de test',
    }, 
  ],
}

// ==============================================
// FONCTIONS UTILITAIRES
// ==============================================

/**
 * Affiche un titre format√©
 */
function printTitle(title: string) {
  console.log('\n' + '='.repeat(70))
  console.log(`  ${title}`)
  console.log('='.repeat(70) + '\n')
}

/**
 * Affiche un sous-titre
 */
function printSubtitle(subtitle: string) {
  console.log('\n' + '-'.repeat(70))
  console.log(`  ${subtitle}`)
  console.log('-'.repeat(70) + '\n')
}

/**
 * Affiche un r√©sultat de validation
 */
function printValidationResult(valid: boolean, errors: string[]) {
  if (valid) {
    console.log('‚úÖ Validation r√©ussie : toutes les donn√©es sont compl√®tes\n')
  } else {
    console.log('‚ùå Validation √©chou√©e : donn√©es incompl√®tes\n')
    console.log('Erreurs d√©tect√©es:')
    errors.forEach((error, index) => {
      console.log(`  ${index + 1}. ${error}`)
    })
    console.log('')
  }
}

/**
 * Affiche les informations du dossier
 */
function printDossierInfo(dossier: Dossier) {
  console.log('Dossier:')
  console.log(`  Num√©ro: ${dossier.numero}`)
  console.log(`  Type: ${dossier.typeDossier}`)
  console.log('')
  
  if (dossier.entrepreneurIndividuel) {
    const ei = dossier.entrepreneurIndividuel
    console.log('Entrepreneur Individuel:')
    console.log(`  Nom complet: ${ei.prenoms} ${ei.nomNaissance}`)
    console.log(`  Nom commercial: ${ei.nomCommercial || 'N/A'}`)
    console.log(`  Date de naissance: ${ei.dateNaissance}`)
    console.log(`  Ville de naissance: ${ei.villeNaissance}`)
    console.log(`  Nationalit√©: ${ei.nationalite}`)
    console.log(`  Situation matrimoniale: ${ei.situationMatrimoniale}`)
    console.log(`  Num√©ro s√©cu: ${ei.numeroSecuriteSociale}`)
    console.log(`  Adresse domicile: ${ei.adresseDomicile}`)
    console.log(`  Adresse √©tablissement: ${ei.adresseEtablissement || 'Identique au domicile'}`)
    console.log(`  Activit√©: ${ei.descriptionActivites}`)
    console.log(`  D√©claration: ${ei.declarationType}`)
    console.log(`  Versement lib√©ratoire: ${ei.optionVersementLiberatoire ? 'Oui' : 'Non'}`)
    console.log('')
  }
  
  console.log('Client:')
  console.log(`  Nom: ${dossier.client.civilite} ${dossier.client.prenom} ${dossier.client.nom}`)
  console.log(`  Email: ${dossier.client.email}`)
  console.log(`  T√©l√©phone: ${dossier.client.telephone}`)
  console.log('')
}

/**
 * Affiche la structure JSON de mani√®re format√©e avec limite de taille
 */
function printJSON(obj: any, title: string, maxDepth: number = 10) {
  console.log(`${title}:`)
  console.log('')
  
  try {
    const json = JSON.stringify(obj, null, 2)
    const lines = json.split('\n')
    
    // Limiter l'affichage si trop volumineux
    if (lines.length > 200) {
      console.log(lines.slice(0, 100).join('\n'))
      console.log('\n... (contenu tronqu√©, trop volumineux) ...\n')
      console.log(lines.slice(-50).join('\n'))
      console.log(`\nüìä Taille totale: ${lines.length} lignes`)
    } else {
      console.log(json)
    }
  } catch (error) {
    console.error('Erreur lors de la s√©rialisation JSON:', error)
  }
  
  console.log('')
}

/**
 * Affiche un r√©sum√© des champs cl√©s
 */
function printFormalitySummary(formalite: any) {
  console.log('R√©sum√© de la formalit√©:')
  console.log(`  Nom: ${formalite.companyName}`)
  console.log(`  Type formalit√©: ${formalite.typeFormalite} (${formalite.typeFormalite === 'C' ? 'Cr√©ation' : 'Autre'})`)
  console.log(`  Type personne: ${formalite.typePersonne} (${formalite.typePersonne === 'P' ? 'Personne Physique' : 'Personne Morale'})`)
  console.log(`  R√©f√©rence mandataire: ${formalite.referenceMandataire}`)
  console.log(`  Diffusion INSEE: ${formalite.diffusionINSEE}`)
  console.log(`  Diffusion commerciale: ${formalite.diffusionCommerciale}`)
  console.log('')
  
  if (formalite.content?.natureCreation) {
    console.log('Nature de cr√©ation:')
    console.log(`  Date cr√©ation: ${formalite.content.natureCreation.dateCreation}`)
    console.log(`  Micro-entreprise: ${formalite.content.natureCreation.microEntreprise ? 'Oui' : 'Non'}`)
    console.log(`  √âtablie en France: ${formalite.content.natureCreation.etablieEnFrance ? 'Oui' : 'Non'}`)
    console.log('')
  }
  
  if (formalite.content?.personnePhysique?.identite?.entrepreneur) {
    const entrepreneur = formalite.content.personnePhysique.identite.entrepreneur
    console.log('Entrepreneur:')
    
    if (entrepreneur.descriptionPersonne) {
      const desc = entrepreneur.descriptionPersonne
      console.log(`  Nom: ${desc.nom}`)
      console.log(`  Pr√©noms: ${desc.prenoms?.join(', ')}`)
      console.log(`  Genre: ${desc.genre === '1' ? 'Masculin' : 'F√©minin'}`)
      console.log(`  Date naissance: ${desc.dateDeNaissance}`)
      console.log(`  Ville naissance: ${desc.villeNaissance}`)
      console.log(`  Pays naissance: ${desc.paysNaissance}`)
      console.log(`  Nationalit√©: ${desc.codeNationalite}`)
      console.log(`  Situation matrimoniale: ${desc.situationMatrimoniale}`)
      console.log(`  Num√©ro s√©cu: ${desc.numeroSecu}`)
    }
    
    if (entrepreneur.regimeMicroSocial) {
      console.log(`  R√©gime micro-social: ${entrepreneur.regimeMicroSocial.optionMicroSocial ? 'Oui' : 'Non'}`)
      console.log(`  P√©riodicit√©: ${entrepreneur.regimeMicroSocial.periodiciteVersement === 'M' ? 'Mensuelle' : 'Trimestrielle'}`)
    }
    
    console.log('')
  }
  
  if (formalite.content?.personnePhysique?.etablissementPrincipal) {
    console.log('√âtablissement principal:')
    const etab = formalite.content.personnePhysique.etablissementPrincipal
    
    if (etab.descriptionEtablissement) {
      console.log(`  R√¥le: ${etab.descriptionEtablissement.rolePourEntreprise}`)
      console.log(`  Enseigne: ${etab.descriptionEtablissement.enseigne || 'N/A'}`)
      console.log(`  √âtablissement principal: ${etab.descriptionEtablissement.indicateurEtablissementPrincipal ? 'Oui' : 'Non'}`)
    }
    
    if (etab.adresse) {
      console.log(`  Adresse: ${etab.adresse.numVoie || ''} ${etab.adresse.typeVoie || ''} ${etab.adresse.voie || ''}`)
      console.log(`  Code postal: ${etab.adresse.codePostal}`)
      console.log(`  Commune: ${etab.adresse.commune}`)
    }
    
    if (etab.activites && etab.activites.length > 0) {
      console.log(`  Activit√©: ${etab.activites[0].descriptionDetaillee}`)
    }
    
    console.log('')
  }
}

// ==============================================
// FONCTION PRINCIPALE
// ==============================================

async function main() {
  const args = process.argv.slice(2)
  const mode = args[0] || '--dry-run'
  
  printTitle('TEST INT√âGRATION GUICHET UNIQUE - ENTREPRENEUR INDIVIDUEL')
  
  console.log(`Mode: ${mode === '--create' ? 'CR√âATION R√âELLE' : 'DRY-RUN (simulation)'}`)
  console.log(`Date: ${new Date().toLocaleString('fr-FR')}`)
  console.log('')
  
  // √âtape 1 : Afficher les informations du dossier
  printSubtitle('√âTAPE 1 : Informations du dossier test')
  printDossierInfo(testDossier)
  
  // √âtape 2 : Validation
  printSubtitle('√âTAPE 2 : Validation des donn√©es')
  const validation = validateDossierEIForGU(testDossier)
  printValidationResult(validation.valid, validation.errors)
  
  if (!validation.valid) {
    console.log('‚ö†Ô∏è  Le test s\'arr√™te ici car les donn√©es ne sont pas valides.')
    process.exit(1)
  }
  
  // √âtape 3 : Mapping
  printSubtitle('√âTAPE 3 : Mapping vers le format Guichet Unique')
  
  try {
    const formalite = await mapDossierEIToGUFormality(testDossier)
    
    console.log('‚úÖ Mapping r√©ussi\n')
    
    // Afficher le r√©sum√©
    printFormalitySummary(formalite)
    
    // Afficher la structure compl√®te (tronqu√©e si trop grande)
    printSubtitle('√âTAPE 4 : Structure JSON compl√®te')
    printJSON(formalite, 'Formalit√© g√©n√©r√©e')
    
    // √âtape 4 : Cr√©ation (optionnelle)
    if (mode === '--create') {
      printSubtitle('√âTAPE 5 : Cr√©ation de la formalit√© sur le Guichet Unique')
      
      // V√©rifier la configuration
      if (!isGuichetUniqueConfigured()) {
        console.log('‚ùå Le Guichet Unique n\'est pas configur√©')
        console.log('   Ajoutez vos credentials dans le fichier .env')
        console.log('   Voir .env.example pour les variables n√©cessaires')
        console.log('')
        process.exit(1)
      }
      
      console.log('üöÄ Cr√©ation de la formalit√© en cours...\n')
      
      try {
        const response = await createDraftFormality(formalite)
        
        console.log('‚úÖ Formalit√© cr√©√©e avec succ√®s !\n')
        console.log('R√©ponse du Guichet Unique:')
        console.log(`  ID: ${response.formalityId}`)
        console.log(`  Statut: ${response.status}`)
        console.log(`  Date cr√©ation: ${response.createdAt}`)
        if (response.url) {
          console.log(`  URL: ${response.url}`)
        }
        if (response.reference) {
          console.log(`  R√©f√©rence: ${response.reference}`)
        }
        
        if (response.warnings && response.warnings.length > 0) {
          console.log('\n‚ö†Ô∏è  Avertissements:')
          response.warnings.forEach((warning, index) => {
            console.log(`  ${index + 1}. ${warning.message}`)
          })
        }
        
        console.log('')
        
      } catch (error: any) {
        console.log('‚ùå Erreur lors de la cr√©ation de la formalit√©\n')
        console.error('D√©tails de l\'erreur:')
        if (error.message) {
          console.error(`  Message: ${error.message}`)
        }
        if (error.statusCode) {
          console.error(`  Code HTTP: ${error.statusCode}`)
        }
        if (error.errors && error.errors.length > 0) {
          console.error('\n  Erreurs d√©taill√©es:')
          error.errors.forEach((err: any, index: number) => {
            console.error(`    ${index + 1}. ${err.message || err}`)
            if (err.field) {
              console.error(`       Champ: ${err.field}`)
            }
          })
        }
        console.log('')
        process.exit(1)
      }
    } else {
      printSubtitle('√âTAPE 5 : Simulation termin√©e')
      console.log('‚úÖ Test en mode dry-run termin√© avec succ√®s')
      console.log('')
      console.log('üí° Pour cr√©er r√©ellement la formalit√© sur le GU, lancez:')
      console.log('   npx ts-node scripts/test-gu-ei.ts --create')
      console.log('')
    }
    
    // R√©sum√© final
    printTitle('R√âSUM√â DU TEST')
    console.log('‚úÖ Validation: OK')
    console.log('‚úÖ Mapping: OK')
    if (mode === '--create') {
      console.log('‚úÖ Cr√©ation: OK')
    } else {
      console.log('‚è≠Ô∏è  Cr√©ation: Non effectu√©e (mode dry-run)')
    }
    console.log('')
    console.log('üéâ Test termin√© avec succ√®s !')
    console.log('')
    
  } catch (error: any) {
    console.log('‚ùå Erreur lors du mapping\n')
    console.error('D√©tails de l\'erreur:')
    console.error(`  Message: ${error.message || error}`)
    if (error.stack) {
      console.error('\nStack trace:')
      console.error(error.stack)
    }
    console.log('')
    process.exit(1)
  }
}

// ==============================================
// EX√âCUTION
// ==============================================

main().catch((error) => {
  console.error('Erreur fatale:', error)
  process.exit(1)
})

